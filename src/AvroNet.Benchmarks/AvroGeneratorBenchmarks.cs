using BenchmarkDotNet.Attributes;
using F0.CodeAnalysis.CSharp.Benchmarking;

namespace AvroNet.Benchmarks;

public class AvroGeneratorBenchmarks
{
    private readonly CSharpIncrementalGeneratorBenchmark<AvroGenerator> benchmark = new();

    [GlobalSetup]
    public void Setup()
    {
        string code = """"
        [AvroClass]
        public partial class User
        {
            public const string SchemaJson = """
            {
                "type" : "record",
                "namespace" : "Tests.User",
                "name" : "User",
                "fields" : [
                    { "name" : "Name" , "type" : "string" },
                    { "name" : "Age" , "type" : "int" },
                ]
            }
            """;
        }
        """";

        benchmark.Initialize(new CSharpIncrementalGeneratorBenchmarkInitializationContext
        {
            Source = code,
        });
    }

    [Benchmark]
    public object Generate()
    {
        return benchmark.Invoke();
    }

    [GlobalCleanup]
    public void Cleanup()
    {
        string attribute = """
        //------------------------------------------------------------------------------
        // <auto-generated>
        //     This code was generated by a tool.
        //
        //     Changes to this file may cause incorrect behavior and will be lost if
        //     the code is regenerated.
        // </auto-generated>
        //------------------------------------------------------------------------------
        #nullable enable
        namespace AvroNet;
        
        [global::System.CodeDom.Compiler.GeneratedCodeAttribute("AvroNet", "1.0.0.0")]
        [global::System.AttributeUsage(global::System.AttributeTargets.Class, AllowMultiple = false)]
        internal sealed class AvroClassAttribute : global::System.Attribute
        {
        }
        #nullable restore
        """;

        string generated = """
            //------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if
            //     the code is regenerated.
            // </auto-generated>
            //------------------------------------------------------------------------------

            namespace AvroNet.IntegrationTests
            {
                using System;
                using System.Collections.Generic;
                using System.Text;
                using global::Avro;
                using global::Avro.Specific;

                [global::System.CodeDom.Compiler.GeneratedCodeAttribute("ServiceHub.Host.dotnet.x64", "1.11.3")]
                public partial class User : global::Avro.Specific.ISpecificRecord
                {
                    public static global::Avro.Schema _SCHEMA = global::Avro.Schema.Parse(SchemaJson);
                    private string _Name;
                    private int _Age;
                    private string _Description;
                    public virtual global::Avro.Schema Schema
                    {
                        get
                        {
                            return User._SCHEMA;
                        }
                    }
                    public string Name
                    {
                        get
                        {
                            return this._Name;
                        }
                        set
                        {
                            this._Name = value;
                        }
                    }
                    public int Age
                    {
                        get
                        {
                            return this._Age;
                        }
                        set
                        {
                            this._Age = value;
                        }
                    }
                    public string Description
                    {
                        get
                        {
                            return this._Description;
                        }
                        set
                        {
                            this._Description = value;
                        }
                    }
                    public virtual object Get(int fieldPos)
                    {
                        switch (fieldPos)
            			{
            			case 0: return this.Name;
            			case 1: return this.Age;
            			case 2: return this.Description;
            			default: throw new global::Avro.AvroRuntimeException("Bad index " + fieldPos + " in Get()");
            			};
                    }
                    public virtual void Put(int fieldPos, object fieldValue)
                    {
                        switch (fieldPos)
            			{
            			case 0: this.Name = (System.String)fieldValue; break;
            			case 1: this.Age = (System.Int32)fieldValue; break;
            			case 2: this.Description = (System.String)fieldValue; break;
            			default: throw new global::Avro.AvroRuntimeException("Bad index " + fieldPos + " in Put()");
            			};
                    }
                }
            }
            """;

        benchmark.Inspect(new CSharpIncrementalGeneratorBenchmarkInspectionContext
        {
            Source = ("AvroClassAttribute.g.cs", attribute),
            AdditionalSources = { ("User.AvroClass.g.cs", generated) },
        });
    }
}
